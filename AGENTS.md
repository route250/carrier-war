# AGENT.md

本リポジトリの開発エージェント向けガイドです。作業開始前に方針と進行管理の更新を行ってください。

## 進行管理
- PvP対応を含む計画と進行状況は `PROGRESS.md` に集約しています。
- 仕様やタスクの変更・合意事項は必ず `PROGRESS.md` を更新して、内容を追加・更新・削除してください。
- 通信プロトコルは、PROTOCOLS.mdに集約しています。必要に応じて内容を追加・更新・削除してください。

## 作業手順（推奨）
1) 目的を確認し、`PROGRESS.md` の該当フェーズ/タスクにチェックやメモを追記。作業がすすむと内容が実情と乖離してくるので、大幅に改訂することもOK
2) 変更を実装（スコープ外の修正は避ける）
3) 動作確認（手元での最小限の確認で可）
4) `PROGRESS.md` に進捗/決定事項/次アクションを記録。実情に一致するように常に項目の見直し(追加削除修正)を行う。

## 実行・デバッグ
- サーバ起動: `./start_server.sh start`
- ログ確認: `./start_server.sh logs -f`
- 終了: `./start_server.sh stop`

## 注意事項
- 既存の PvE API（`/v1/session`）は後方互換を維持します。
- 今後の PvP 実装は新規 `/v1/match` 系 API に追加します。
- 将来的にワーカー数を増やす場合は外部ストア移行を検討し、コードはその前提で分離実装してください。


## 共通化ポリシー / Pythonic ガイド
- 共通化: 重複する処理は関数/ユーティリティ/基底クラスへ集約し、DRYを徹底。
- データ管理: 用途に応じて `class`/`dataclass`/`BaseModel` を使い分け。
  - 内部状態の純粋なデータ: `@dataclass`（不変が望ましい箇所は `frozen=True` を検討）。
  - API I/O とバリデーション: Pydantic の `BaseModel` を使用（既存の `server/schemas.py` と整合）。
  - 振る舞いを持つ領域: 明確な責務を持つ `class` を定義（小さなメソッド、単一責務）。
- スタイル: PEP 8/PEP 484 準拠、タイプヒント必須、Docstring（Google/Numpyスタイルいずれかで統一）。
- 設計原則: 小さい関数、早期リターン（EAFP）、コンテキストマネージャの活用、例外は境界で握る。
- 関心分離: ルータ（入出力）/サービス（ドメイン）/ストア（状態保持）/ユーティリティ（共通）を分ける。
- 再利用: グリッド/視界/移動/戦闘などの共通アルゴリズムは `server/services` または `server/utils` に集約して PvE/PvP 両方から利用。
- 依存注入: 定数/設定は引数または設定オブジェクト経由で渡し、テスト容易性を確保。
- 命名/定数: わかりやすい命名、マジックナンバー禁止、共通定数は単一の定義箇所に集約。
- フォールバックはいらない。シンプルにエラー停止のほうがいい。
- バグの調査は、関連する情報が格納されているクラス・変数を明確化、関連する処理を明確に、通信内容も明確に。原因を明確化してから修正する。


## ユーザとの会話は日本語で行う。
